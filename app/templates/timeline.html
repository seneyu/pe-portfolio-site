{% extends "layout.html" %} {% set name = name %} {% set title = "Timeline
Posts" %} {% block styles %}
<link rel="stylesheet" href="/static/styles/timeline-posts.css" />
{% endblock %} {% block content %}
<div class="timeline-container">
  <form action="/api/timeline_post" method="POST" id="timeline-form">
    <div class="form-row">
      <label for="name">
        Name:
        <input type="text" name="name" id="name" value="" />
      </label>

      <label for="email">
        Email:
        <input type="email" name="email" id="email" value="" />
      </label>
    </div>

    <label for="content" class="message-label">
      Message:
      <input
        type="text"
        name="content"
        id="content"
        class="message-input"
        value="" />
    </label>

    <button type="submit">Submit</button>
  </form>

  <div id="posts"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>

<script>
  const postsDiv = document.getElementById('posts');

  function getSHA256Hash(email) {
    return sha256(email.trim().toLowerCase());
  }

  function renderPost(post) {
    const hash = getSHA256Hash(post.email);
    const gravatarUrl = `https://gravatar.com/avatar/${hash}?s=64&d=identicon`;

    const div = document.createElement('div');
    div.classList.add('post');

    div.innerHTML = `
      <img src="${gravatarUrl}" alt="Profile" />
      <div class="post-content">
        <strong>${post.name}</strong> (${post.email}): ${post.content}
        <span class="timestamp"> - ${post.created_at}</span>
      </div>
    `;
    return div;
  }

  async function fetchPosts() {
    try {
      const response = await fetch('/api/timeline_post');
      const data = await response.json();

      postsDiv.innerHTML = '';
      for (const post of data.timeline_post) {
        postsDiv.appendChild(renderPost(post));
      }
    } catch (error) {
      console.error('Error fetching posts:', error);
    }
  }

  const form = document.getElementById('timeline-form');
  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = new FormData(form);
    const response = await fetch('/api/timeline_post', {
      method: 'POST',
      body: formData,
    });
    const post = await response.json();

    const postDiv = renderPost(post);
    postsDiv.insertBefore(postDiv, postsDiv.firstChild);

    form.reset();
  });

  fetchPosts();
</script>
{% endblock %}
